import{L as C,i as v,V as i,W as y,r as f,X as d,o as S,M as R,d as A,c as M,G as u,a as h,A as x,n as P,t as w,g as D}from"./index.standard-DHpxIVC0.js";import{_ as T}from"./_plugin-vue_export-helper-DlAUqK2U.js";function N(){const n=C(),t=v(()=>{const e=n.user;return{isAuthenticated:n.isAuthenticated,isAdmin:(e==null?void 0:e.role)==="admin",isManager:(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="sales_manager",isSalesRep:(e==null?void 0:e.role)==="sales_rep",isViewer:(e==null?void 0:e.role)==="viewer",canManageUsers:i("user_management"),canManageProducts:i("product_management"),canManageCustomers:i("customer_management"),canApproveQuotes:i("quote_approval"),canExportData:i("quote_export"),canViewLogs:i("system_logs"),canAccessSettings:i("system_settings"),canManageRoles:i("user_roles"),showAdminMenu:(e==null?void 0:e.role)==="admin",showUserManagement:i("user_management"),showSystemSettings:i("system_settings"),showAdvancedFeatures:(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="sales_manager",canEditOwnProfile:!!e,canDeleteRecords:(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="sales_manager",canBulkOperations:(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="sales_manager",canViewAllData:(e==null?void 0:e.role)==="admin"||(e==null?void 0:e.role)==="sales_manager",currentUser:e,userRole:(e==null?void 0:e.role)||null,userName:(e==null?void 0:e.name)||(e==null?void 0:e.username)||""}});return{permissions:t,checkPermission:{canAccessRoute(e){return y(n.user,e)},canAccessFeature(e){return i(e)},hasRole(e){var a;return((a=n.user)==null?void 0:a.role)===e},hasAnyRole(e){var a;return e.includes(((a=n.user)==null?void 0:a.role)||"")},canPerformAction(e,a){var c;const o=n.user;return o?(((c={create:{user:["admin"],product:["admin","sales_manager"],customer:["admin","sales_manager"],quote:["admin","sales_manager","sales_rep"]},edit:{user:["admin"],product:["admin","sales_manager"],customer:["admin","sales_manager"],quote:["admin","sales_manager","sales_rep"]},delete:{user:["admin"],product:["admin"],customer:["admin"],quote:["admin","sales_manager"]},view:{user:["admin","sales_manager"],product:["admin","sales_manager","sales_rep","viewer"],customer:["admin","sales_manager","sales_rep","viewer"],quote:["admin","sales_manager","sales_rep","viewer"]},approve:{quote:["admin","sales_manager"]},export:{data:["admin","sales_manager"]}}[e])==null?void 0:c[a||"default"])||[]).includes(o.role):!1},canAccessAdminPanel(){return this.hasAnyRole(["admin","sales_manager","sales_rep","viewer"])},ownsResource(e){var a;return((a=n.user)==null?void 0:a.id)===e},canModifyResource(e){return this.ownsResource(e)||this.hasAnyRole(["admin","sales_manager"])}},uiHelpers:{getPermissionDeniedMessage(e){return{view:"您没有权限查看此内容",edit:"您没有权限编辑此内容",delete:"您没有权限删除此内容",create:"您没有权限创建此内容",access:"您没有权限访问此功能"}[e||"access"]||"权限不足"},showPermissionDenied(e){uni.showToast({title:this.getPermissionDeniedMessage(e),icon:"none",duration:2e3})},getRoleDisplayName(e){var o;return{admin:"系统管理员",sales_manager:"销售经理",sales_rep:"销售代表",viewer:"查看者"}[e||((o=n.user)==null?void 0:o.role)||""]||"未知角色"},getRoleBadgeColor(e){var o;return{admin:"#ef4444",sales_manager:"#f59e0b",sales_rep:"#3b82f6",viewer:"#6b7280"}[e||((o=n.user)==null?void 0:o.role)||""]||"#6b7280"}},isAuthenticated:t.value.isAuthenticated,isAdmin:t.value.isAdmin,isManager:t.value.isManager,currentUser:t.value.currentUser,userRole:t.value.userRole}}function I(){const n=f(d.getConnectionStatus()),t=f(null);let r=null;const s=v(()=>({isConnected:n.value.isConnected,channelCount:n.value.channelCount,channels:n.value.channels,statusText:n.value.isConnected?"已连接":"未连接",statusIcon:n.value.isConnected?"🟢":"🔴",lastUpdate:t.value,isHealthy:n.value.isConnected&&n.value.channelCount>0,hasAllChannels:n.value.channelCount>=3,connectionQuality:e()}));function e(){return n.value.isConnected?n.value.channelCount>=4?"excellent":n.value.channelCount>=3?"good":"poor":"disconnected"}function a(){const l=d.getConnectionStatus();JSON.stringify(n.value)!==JSON.stringify(l)&&(n.value=l,t.value=new Date)}S(()=>{a(),r=setInterval(a,5e3)}),R(()=>{r&&(clearInterval(r),r=null)});const o={getStatusColor(){switch(s.value.connectionQuality){case"excellent":return"#10b981";case"good":return"#3b82f6";case"poor":return"#f59e0b";case"disconnected":return"#ef4444";default:return"#6b7280"}},getStatusMessage(){const{isConnected:l,channelCount:c}=n.value;return l?c===0?"正在连接实时更新服务...":c<3?`实时更新部分可用 (${c}/4 个频道)`:c>=4?"实时更新服务运行正常":`实时更新已连接 (${c} 个频道)`:"实时更新已断开，数据可能不是最新的"},getBadgeProps(){return{text:s.value.statusText,color:this.getStatusColor(),icon:s.value.statusIcon,pulse:!s.value.isConnected}},showStatusToast(){uni.showToast({title:this.getStatusMessage(),icon:"none",duration:3e3})},formatLastUpdate(){if(!t.value)return"未知";const c=new Date().getTime()-t.value.getTime(),m=Math.floor(c/1e3),g=Math.floor(m/60),p=Math.floor(g/60);return m<60?`${m}秒前`:g<60?`${g}分钟前`:p<24?`${p}小时前`:t.value.toLocaleDateString("zh-CN")}},_={refresh(){a()},async reconnect(){try{uni.showLoading({title:"重新连接中..."}),await d.reconnect(),a(),uni.hideLoading(),uni.showToast({title:"重新连接成功",icon:"success"})}catch(l){uni.hideLoading(),uni.showToast({title:"重新连接失败",icon:"none"}),console.error("Reconnection failed:",l)}},async toggle(){n.value.isConnected?(await d.disconnect(),uni.showToast({title:"实时更新已关闭",icon:"none"})):await this.reconnect(),a()},showConnectionDetails(){const l=[`连接状态: ${s.value.statusText}`,`频道数量: ${n.value.channelCount}`,`连接质量: ${e()}`,`最后更新: ${o.formatLastUpdate()}`,`活跃频道: ${n.value.channels.join(", ")}`].join(`
`);uni.showModal({title:"实时连接详情",content:l,showCancel:!1})}};return{connectionStatus:s,status:n.value,lastUpdateTime:t,statusUtils:o,actions:_,isConnected:s.value.isConnected,isHealthy:s.value.isHealthy,channelCount:n.value.channelCount,connectionQuality:s.value.connectionQuality}}function U(){const{connectionStatus:n,statusUtils:t,actions:r}=I();return{indicatorProps:v(()=>({color:t.getStatusColor(),text:n.value.statusText,icon:n.value.statusIcon,pulse:!n.value.isConnected,title:t.getStatusMessage()})),onIndicatorClick:r.showConnectionDetails,isConnected:n.value.isConnected,quality:n.value.connectionQuality}}const $={class:"status-text"},b={class:"status-icon"},k=A({__name:"RealtimeIndicator",setup(n){const{indicatorProps:t,onIndicatorClick:r}=U();return(s,e)=>(D(),M("view",{class:"realtime-indicator",onClick:e[0]||(e[0]=(...a)=>u(r)&&u(r)(...a))},[h("view",{class:P(["status-dot",{pulse:u(t).pulse}]),style:x({backgroundColor:u(t).color})},null,6),h("text",$,w(u(t).text),1),h("text",b,w(u(t).icon),1)]))}}),Q=T(k,[["__scopeId","data-v-d9809860"]]);export{Q as R,N as u};
