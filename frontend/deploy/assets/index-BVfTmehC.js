import{d as je,O as Ge,r as o,i as Ye,o as Je,c as b,a as e,j as d,t as a,G as i,p as G,b as _,v as f,x as w,k as v,y as K,F as ce,f as de,m as ve,g as m,A as We,n as me,u as Xe}from"./index.standard-DHpxIVC0.js";import{u as Ze,T as Ke,c as et,B as tt,D as lt,a as pe}from"./common-actions-DhrMkVRx.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const st={class:"customers-page"},at={class:"page-header"},ot={class:"header-content"},nt={class:"header-stats"},it={class:"stat-item"},ut={class:"stat-value"},rt={class:"stat-item"},ct={class:"stat-value"},dt={class:"stat-item"},vt={class:"stat-value"},mt={class:"stat-item"},pt={class:"stat-value"},ft={class:"header-actions"},wt=["loading"],xt={class:"filters-section"},bt={class:"filters-row"},ht={class:"filter-item"},_t={class:"filter-item"},gt={class:"filter-picker"},yt={class:"filter-item"},kt={class:"filter-picker"},Ct={class:"filter-item"},St={class:"filter-picker"},Tt={class:"filter-item"},Vt={key:0,class:"advanced-filters"},At={class:"advanced-filters-row"},Dt={class:"filter-item"},It={class:"date-range"},Ut={class:"date-picker"},Ft={class:"date-picker"},Ot={class:"filter-item"},$t={class:"amount-range"},Bt={class:"filter-checkbox"},Et={class:"toggle-icon"},Mt={class:"enhanced-table"},Nt={class:"table-header"},Qt={class:"header-row"},Rt={key:0,class:"header-selector"},zt=["onClick"],Ht={class:"header-title"},Pt={key:0,class:"sort-icon"},qt={class:"table-body"},Lt={class:"customer-cell"},jt={class:"customer-main"},Gt={class:"customer-name"},Yt={class:"customer-phone"},Jt={class:"customer-tags"},Wt={class:"contact-cell"},Xt={key:0,class:"contact-item"},Zt={key:1,class:"contact-item"},Kt={key:2,class:"contact-item"},el={class:"metrics-cell"},tl={class:"metric-item"},ll={class:"metric-value"},sl={class:"metric-item"},al={class:"metric-value"},ol={class:"date-cell"},nl={key:2,class:"empty-state"},il={key:0,class:"table-pagination"},ul={class:"pagination-info"},rl={class:"pagination-controls"},cl=["disabled"],dl=["disabled"],vl={class:"customer-form"},ml={class:"form-row"},pl={class:"form-item"},fl={class:"form-item"},wl={class:"form-row"},xl={class:"form-item"},bl={class:"form-picker"},hl={class:"form-item"},_l={class:"form-picker"},gl={key:0,class:"form-item"},yl={class:"form-row"},kl={class:"form-item"},Cl={class:"form-item"},Sl={class:"form-row"},Tl={class:"form-item"},Vl={class:"form-item"},Al={class:"form-item"},Dl={class:"form-item"},Il={class:"export-form"},Ul={class:"form-item"},Fl={class:"form-picker"},Ol={class:"form-checkboxes"},$l={class:"checkbox-group"},Bl={class:"checkbox-item"},El={class:"checkbox-item"},Hl=je({__name:"index",setup(Ml){Xe();const r=Ge(),{selectedItems:A,selectAllChecked:ee,selectAllIndeterminate:te,toggleSelection:fe,selectAll:we,clearSelection:le,handleRowSelect:Nl}=Ze(),Y=[{key:"customer",label:"客户信息",width:"250px",type:"text"},{key:"contact",label:"联系方式",width:"200px",type:"text"},{key:"status",label:"状态",width:"100px",align:"center",type:"status"},{key:"source",label:"来源",width:"100px",align:"center",type:"status"},{key:"business_metrics",label:"业务数据",width:"150px",align:"center",type:"text"},{key:"last_activity",label:"最后活动",width:"120px",sortable:!0,type:"date"},{key:"created_at",label:"创建时间",width:"120px",sortable:!0,type:"date"}],xe=[pe.customers.view,pe.customers.export],be=et.customers,J=o(""),R=o("asc"),O=o(!1),h=o(0),y=o(""),se=Ye(()=>Math.ceil(r.totalCount/z.value)),$=o(""),D=o(""),I=o(0),U=o(0),F=o(0),c=o(1),z=o(20),k=o(""),C=o(""),B=o(""),E=o(""),H=o(!1),M=o(!1),W=o(!1),S=[{value:"",label:"全部类型"},{value:"individual",label:"个人客户"},{value:"business",label:"企业客户"}],P=[{value:"",label:"全部状态"},{value:"active",label:"活跃"},{value:"inactive",label:"停用"},{value:"potential",label:"潜在客户"},{value:"blacklist",label:"黑名单"}],T=[{value:"",label:"全部来源"},{value:"walk_in",label:"到店咨询"},{value:"referral",label:"朋友推荐"},{value:"online",label:"网络咨询"},{value:"phone",label:"电话咨询"},{value:"exhibition",label:"展会"},{value:"other",label:"其他"}],N=o(!1),Q=o(!1),n=o({name:"",phone:"",email:"",wechat_id:"",company:"",address:"",city:"",district:"",customer_type:"individual",source:"walk_in",notes:""}),q=o(0),L=o(0),g=o({includeQuoteHistory:!0,includeActivities:!1,format:"excel"}),X=o(0),Z=[{value:"excel",label:"Excel (.xlsx)"},{value:"csv",label:"CSV (.csv)"}];Je(()=>{x()});let ae;const j=()=>{clearTimeout(ae),ae=setTimeout(()=>{c.value=1,x()},500)};async function x(){const l={page:c.value,pageSize:z.value};$.value&&(l.search=$.value),D.value&&(l.city=D.value);const t=S[I.value].value;t&&(l.customer_type=t);const p=P[U.value].value;p&&(l.status=p);const V=T[F.value].value;V&&(l.source=V),k.value&&(l.startDate=k.value),C.value&&(l.endDate=C.value),B.value&&(l.minAmount=parseFloat(B.value)),E.value&&(l.maxAmount=parseFloat(E.value)),H.value&&(l.hasQuotes=!0),await r.fetchCustomers(l)}function he(l){I.value=l.detail.value,c.value=1,x()}function _e(l){U.value=l.detail.value,c.value=1,x()}function ge(l){F.value=l.detail.value,c.value=1,x()}function ye(l){k.value=l.detail.value,c.value=1,x()}function ke(l){C.value=l.detail.value,c.value=1,x()}function Ce(){c.value=1,x()}function Se(){$.value="",D.value="",I.value=0,U.value=0,F.value=0,k.value="",C.value="",B.value="",E.value="",H.value=!1,c.value=1,x()}function Te(l,t){fe(t.id)}function Ve(l){}function Ae(l,t){switch(l){case"view":$e(t);break;case"export":Fe(t);break;default:console.warn("Unknown action:",l)}}function oe(l){const t=l.detail?l.detail.value:l;we(r.customers.map(p=>p.id),t)}function De(l){J.value===l?R.value=R.value==="asc"?"desc":"asc":(J.value=l,R.value="asc"),c.value=1,x()}function Ie(l){return J.value!==l?"↕":R.value==="asc"?"↑":"↓"}function ne(l){c.value=l,x()}async function Ue(l,t){l==="export"&&await Oe()}async function Fe(l){try{O.value=!0,h.value=50,y.value="导出客户数据...";const t={...g.value,customerIds:[l.id]};await r.exportCustomers(t),h.value=100,y.value="导出完成",uni.showToast({title:"导出成功",icon:"success"})}catch{uni.showToast({title:"导出失败",icon:"none"})}finally{setTimeout(()=>{O.value=!1,h.value=0,y.value=""},1e3)}}async function Oe(){try{O.value=!0,h.value=0,y.value=`导出 ${A.value.length} 个客户...`;const l={...g.value,customerIds:A.value},t=setInterval(()=>{h.value<90&&(h.value+=10)},200);await r.exportCustomers(l),clearInterval(t),h.value=100,y.value="导出完成",uni.showToast({title:`成功导出 ${A.value.length} 个客户`,icon:"success"}),le()}catch{uni.showToast({title:"批量导出失败",icon:"none"})}finally{setTimeout(()=>{O.value=!1,h.value=0,y.value=""},1e3)}}function $e(l){uni.navigateTo({url:`/pages/admin/customers/detail?id=${l.id}`})}function ie(){n.value={name:"",phone:"",email:"",wechat_id:"",company:"",address:"",city:"",district:"",customer_type:"individual",source:"walk_in",notes:""},q.value=0,L.value=0,N.value=!0}function Be(l){q.value=l.detail.value,n.value.customer_type=S[l.detail.value+1].value}function Ee(l){L.value=l.detail.value,n.value.source=T[l.detail.value+1].value}async function Me(){if(!n.value.name||!n.value.phone){uni.showToast({title:"请填写必填项",icon:"none"});return}try{await r.createCustomer(n.value),uni.showToast({title:"添加成功",icon:"success"}),N.value=!1,x()}catch{uni.showToast({title:"添加失败",icon:"none"})}}function Ne(){N.value=!1}function Qe(){uni.showToast({title:"导入功能开发中",icon:"none"})}function Re(){Q.value=!0}function ze(l){X.value=l.detail.value,g.value.format=Z[l.detail.value].value}async function He(){W.value=!0;try{const l={...g.value,customer_type:S[I.value].value,status:P[U.value].value,source:T[F.value].value,city:D.value||void 0,startDate:k.value||void 0,endDate:C.value||void 0};await r.exportCustomers(l),uni.showToast({title:"导出成功",icon:"success"}),Q.value=!1}catch{uni.showToast({title:"导出失败",icon:"none"})}finally{W.value=!1}}function Pe(){Q.value=!1}function ue(l){return l.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}function qe(l){const t=new Date(l);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function Le(l){return{individual:"个人",business:"企业"}[l]||l}return(l,t)=>{const p=K("picker"),V=K("checkbox"),re=K("modal");return m(),b("view",st,[e("view",at,[e("view",ot,[t[25]||(t[25]=e("text",{class:"page-title"},"客户管理",-1)),e("view",nt,[e("text",it,[e("text",ut,a(i(r).totalCount),1),t[21]||(t[21]=e("text",{class:"stat-label"},"总客户",-1))]),e("text",rt,[e("text",ct,a(i(r).statistics.active),1),t[22]||(t[22]=e("text",{class:"stat-label"},"活跃客户",-1))]),e("text",dt,[e("text",vt,a(i(r).statistics.business),1),t[23]||(t[23]=e("text",{class:"stat-label"},"企业客户",-1))]),e("text",mt,[e("text",pt,"¥"+a(ue(i(r).statistics.total_revenue)),1),t[24]||(t[24]=e("text",{class:"stat-label"},"总成交额",-1))])])]),e("view",ft,[e("button",{class:"action-btn add-btn",onClick:ie},t[26]||(t[26]=[e("text",{class:"btn-icon"},"+",-1),G(" 新增客户 ",-1)])),e("button",{class:"action-btn import-btn",onClick:Qe},t[27]||(t[27]=[e("text",{class:"btn-icon"},"📥",-1),G(" 导入客户 ",-1)])),e("button",{class:"action-btn export-btn",onClick:Re,loading:W.value},t[28]||(t[28]=[e("text",{class:"btn-icon"},"📊",-1),G(" 导出数据 ",-1)]),8,wt)])]),e("view",xt,[e("view",bt,[e("view",ht,[f(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>$.value=s),class:"search-input",placeholder:"搜索姓名、电话、公司",onInput:j},null,544),[[w,$.value]])]),e("view",_t,[d(p,{mode:"selector",range:S,"range-key":"label",value:I.value,onChange:he},{default:v(()=>[e("view",gt,[e("text",null,a(S[I.value].label),1),t[29]||(t[29]=e("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),e("view",yt,[d(p,{mode:"selector",range:P,"range-key":"label",value:U.value,onChange:_e},{default:v(()=>[e("view",kt,[e("text",null,a(P[U.value].label),1),t[30]||(t[30]=e("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),e("view",Ct,[d(p,{mode:"selector",range:T,"range-key":"label",value:F.value,onChange:ge},{default:v(()=>[e("view",St,[e("text",null,a(T[F.value].label),1),t[31]||(t[31]=e("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),e("view",Tt,[f(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>D.value=s),class:"search-input",placeholder:"城市筛选",onInput:j},null,544),[[w,D.value]])]),e("button",{class:"filter-reset",onClick:Se},"重置")]),M.value?(m(),b("view",Vt,[e("view",At,[e("view",Dt,[t[33]||(t[33]=e("text",{class:"filter-label"},"创建时间",-1)),e("view",It,[d(p,{mode:"date",value:k.value,onChange:ye},{default:v(()=>[e("view",Ut,[e("text",null,a(k.value||"开始日期"),1)])]),_:1},8,["value"]),t[32]||(t[32]=e("text",{class:"date-separator"},"至",-1)),d(p,{mode:"date",value:C.value,onChange:ke},{default:v(()=>[e("view",Ft,[e("text",null,a(C.value||"结束日期"),1)])]),_:1},8,["value"])])]),e("view",Ot,[t[35]||(t[35]=e("text",{class:"filter-label"},"成交金额",-1)),e("view",$t,[f(e("input",{"onUpdate:modelValue":t[2]||(t[2]=s=>B.value=s),class:"amount-input",placeholder:"最小金额",type:"number",onInput:j},null,544),[[w,B.value]]),t[34]||(t[34]=e("text",{class:"amount-separator"},"-",-1)),f(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>E.value=s),class:"amount-input",placeholder:"最大金额",type:"number",onInput:j},null,544),[[w,E.value]])])]),e("view",Bt,[d(V,{modelValue:H.value,"onUpdate:modelValue":t[4]||(t[4]=s=>H.value=s),onChange:Ce,color:"#007AFF"},null,8,["modelValue"]),t[36]||(t[36]=e("text",{class:"checkbox-label"},"仅显示有报价记录的客户",-1))])])])):_("",!0),e("button",{class:"advanced-toggle",onClick:t[5]||(t[5]=s=>M.value=!M.value)},[G(a(M.value?"收起高级筛选":"展开高级筛选")+" ",1),e("text",Et,a(M.value?"▲":"▼"),1)])]),e("view",Mt,[e("view",Nt,[e("view",Qt,[i(A).length>0?(m(),b("view",Rt,[d(V,{checked:i(ee),indeterminate:i(te),onChange:oe},null,8,["checked","indeterminate"])])):_("",!0),(m(),b(ce,null,de(Y,s=>e("view",{key:s.key,class:me(["header-cell",[`align-${s.align||"left"}`,{sortable:s.sortable}]]),style:We({width:s.width,flex:s.flex}),onClick:u=>s.sortable&&De(s.key)},[e("text",Ht,a(s.label),1),s.sortable?(m(),b("text",Pt,a(Ie(s.key)),1)):_("",!0)],14,zt)),64))])]),e("view",qt,[i(r).loading?(m(),ve(Ke,{key:0,rows:z.value,columns:Y.length,"has-selection":!0,"show-header":!1},null,8,["rows","columns"])):(m(!0),b(ce,{key:1},de(i(r).customers,s=>(m(),ve(lt,{key:s.id,item:s,columns:Y,selectable:!0,selected:i(A).includes(s.id),actions:xe,"touch-optimized":!0,onSelect:Te,onClick:Ve,onAction:Ae},{"cell-customer":v(({item:u})=>[e("view",Lt,[e("view",jt,[e("text",Gt,a(i(r).getCustomerDisplayName(u)),1),e("text",Yt,a(u.phone),1)]),e("view",Jt,[e("view",{class:me(["customer-type-tag",`type-${u.customer_type}`])},[e("text",null,a(Le(u.customer_type)),1)],2)])])]),"cell-contact":v(({item:u})=>[e("view",Wt,[u.email?(m(),b("text",Xt,"📧 "+a(u.email),1)):_("",!0),u.wechat_id?(m(),b("text",Zt,"💬 "+a(u.wechat_id),1)):_("",!0),u.address?(m(),b("text",Kt,"📍 "+a(u.city)+a(u.district),1)):_("",!0)])]),"cell-business_metrics":v(({item:u})=>[e("view",el,[e("text",tl,[e("text",ll,a(u.total_quotes||0),1),t[37]||(t[37]=e("text",{class:"metric-label"},"报价",-1))]),e("text",sl,[e("text",al,"¥"+a(ue(u.total_amount||0)),1),t[38]||(t[38]=e("text",{class:"metric-label"},"成交额",-1))])])]),"cell-last_activity":v(({item:u})=>[e("text",ol,a(u.last_quote_at?qe(u.last_quote_at):"无记录"),1)]),_:2},1032,["item","selected"]))),128)),!i(r).loading&&i(r).customers.length===0?(m(),b("view",nl,[t[39]||(t[39]=e("text",{class:"empty-text"},"暂无客户数据",-1)),e("button",{class:"empty-action",onClick:ie},"新增客户")])):_("",!0)]),i(r).totalCount>z.value?(m(),b("view",il,[e("view",ul," 共 "+a(i(r).totalCount)+" 条，第 "+a(c.value)+"/"+a(se.value)+" 页 ",1),e("view",rl,[e("button",{class:"pagination-btn",disabled:c.value<=1,onClick:t[6]||(t[6]=s=>ne(c.value-1))}," 上一页 ",8,cl),e("button",{class:"pagination-btn",disabled:c.value>=se.value,onClick:t[7]||(t[7]=s=>ne(c.value+1))}," 下一页 ",8,dl)])])):_("",!0)]),d(tt,{"selected-count":i(A).length,operations:i(be),"show-progress":O.value,"current-progress":h.value,"progress-text":y.value,"select-all-checked":i(ee),"select-all-indeterminate":i(te),onOperation:Ue,onClearSelection:i(le),onSelectAll:oe},null,8,["selected-count","operations","show-progress","current-progress","progress-text","select-all-checked","select-all-indeterminate","onClearSelection"]),d(re,{visible:N.value,"onUpdate:visible":t[17]||(t[17]=s=>N.value=s),title:"新增客户",onConfirm:Me,onCancel:Ne},{default:v(()=>[e("view",vl,[e("view",ml,[e("view",pl,[t[40]||(t[40]=e("text",{class:"form-label"},"客户姓名 *",-1)),f(e("input",{"onUpdate:modelValue":t[8]||(t[8]=s=>n.value.name=s),class:"form-input",placeholder:"请输入客户姓名"},null,512),[[w,n.value.name]])]),e("view",fl,[t[41]||(t[41]=e("text",{class:"form-label"},"联系电话 *",-1)),f(e("input",{"onUpdate:modelValue":t[9]||(t[9]=s=>n.value.phone=s),class:"form-input",placeholder:"请输入手机号",type:"tel"},null,512),[[w,n.value.phone]])])]),e("view",wl,[e("view",xl,[t[43]||(t[43]=e("text",{class:"form-label"},"客户类型 *",-1)),d(p,{mode:"selector",range:S.slice(1),"range-key":"label",value:q.value,onChange:Be},{default:v(()=>{var s;return[e("view",bl,[e("text",null,a(((s=S[q.value+1])==null?void 0:s.label)||"请选择类型"),1),t[42]||(t[42]=e("text",{class:"picker-arrow"},"▼",-1))])]}),_:1},8,["range","value"])]),e("view",hl,[t[45]||(t[45]=e("text",{class:"form-label"},"客户来源",-1)),d(p,{mode:"selector",range:T.slice(1),"range-key":"label",value:L.value,onChange:Ee},{default:v(()=>{var s;return[e("view",_l,[e("text",null,a(((s=T[L.value+1])==null?void 0:s.label)||"请选择来源"),1),t[44]||(t[44]=e("text",{class:"picker-arrow"},"▼",-1))])]}),_:1},8,["range","value"])])]),n.value.customer_type==="business"?(m(),b("view",gl,[t[46]||(t[46]=e("text",{class:"form-label"},"公司名称",-1)),f(e("input",{"onUpdate:modelValue":t[10]||(t[10]=s=>n.value.company=s),class:"form-input",placeholder:"请输入公司名称"},null,512),[[w,n.value.company]])])):_("",!0),e("view",yl,[e("view",kl,[t[47]||(t[47]=e("text",{class:"form-label"},"邮箱地址",-1)),f(e("input",{"onUpdate:modelValue":t[11]||(t[11]=s=>n.value.email=s),class:"form-input",placeholder:"请输入邮箱",type:"email"},null,512),[[w,n.value.email]])]),e("view",Cl,[t[48]||(t[48]=e("text",{class:"form-label"},"微信号",-1)),f(e("input",{"onUpdate:modelValue":t[12]||(t[12]=s=>n.value.wechat_id=s),class:"form-input",placeholder:"请输入微信号"},null,512),[[w,n.value.wechat_id]])])]),e("view",Sl,[e("view",Tl,[t[49]||(t[49]=e("text",{class:"form-label"},"城市",-1)),f(e("input",{"onUpdate:modelValue":t[13]||(t[13]=s=>n.value.city=s),class:"form-input",placeholder:"请输入城市"},null,512),[[w,n.value.city]])]),e("view",Vl,[t[50]||(t[50]=e("text",{class:"form-label"},"区域",-1)),f(e("input",{"onUpdate:modelValue":t[14]||(t[14]=s=>n.value.district=s),class:"form-input",placeholder:"请输入区域"},null,512),[[w,n.value.district]])])]),e("view",Al,[t[51]||(t[51]=e("text",{class:"form-label"},"详细地址",-1)),f(e("input",{"onUpdate:modelValue":t[15]||(t[15]=s=>n.value.address=s),class:"form-input",placeholder:"请输入详细地址"},null,512),[[w,n.value.address]])]),e("view",Dl,[t[52]||(t[52]=e("text",{class:"form-label"},"备注信息",-1)),f(e("textarea",{"onUpdate:modelValue":t[16]||(t[16]=s=>n.value.notes=s),class:"form-textarea",placeholder:"请输入备注信息...",maxlength:"200"},null,512),[[w,n.value.notes]])])])]),_:1},8,["visible"]),d(re,{visible:Q.value,"onUpdate:visible":t[20]||(t[20]=s=>Q.value=s),title:"导出客户数据",onConfirm:He,onCancel:Pe},{default:v(()=>[e("view",Il,[e("view",Ul,[t[54]||(t[54]=e("text",{class:"form-label"},"导出格式",-1)),d(p,{mode:"selector",range:Z,"range-key":"label",value:X.value,onChange:ze},{default:v(()=>[e("view",Fl,[e("text",null,a(Z[X.value].label),1),t[53]||(t[53]=e("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),e("view",Ol,[t[57]||(t[57]=e("text",{class:"form-section-title"},"包含数据",-1)),e("view",$l,[e("view",Bl,[d(V,{modelValue:g.value.includeQuoteHistory,"onUpdate:modelValue":t[18]||(t[18]=s=>g.value.includeQuoteHistory=s),color:"#007AFF"},null,8,["modelValue"]),t[55]||(t[55]=e("text",{class:"checkbox-label"},"报价历史",-1))]),e("view",El,[d(V,{modelValue:g.value.includeActivities,"onUpdate:modelValue":t[19]||(t[19]=s=>g.value.includeActivities=s),color:"#007AFF"},null,8,["modelValue"]),t[56]||(t[56]=e("text",{class:"checkbox-label"},"活动记录",-1))])])]),t[58]||(t[58]=e("view",{class:"form-note"},[e("text",null,"导出将包含当前筛选条件下的所有客户数据")],-1))])]),_:1},8,["visible"])])}}});export{Hl as default};
