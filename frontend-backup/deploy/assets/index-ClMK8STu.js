import{d as ye,I as Ce,r as n,i as Te,o as Se,c as w,a as t,j as k,t as i,G as l,p as Ae,v as L,x as G,k as _,y as q,b as B,F as H,f as J,m as W,g as v,A as Ie,n as je,u as Be}from"./index.standard-DHpxIVC0.js";import{u as De,T as $e,c as Qe,B as Re,D as Oe,a as D}from"./common-actions-DhrMkVRx.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"quotes-page"},Ve={class:"page-header"},Ee={class:"header-content"},Pe={class:"header-stats"},ze={class:"stat-item"},Me={class:"stat-value"},Fe={class:"stat-item"},Ne={class:"stat-value"},Ue={class:"header-actions"},Le=["loading"],Ge={class:"filters-section"},He={class:"filters-row"},Je={class:"filter-item"},We={class:"filter-item"},Xe={class:"filter-picker"},Ye={class:"filter-item"},Ze={class:"filter-picker"},Ke={class:"filter-item"},et={class:"filter-picker"},tt={class:"enhanced-table"},at={class:"table-header"},st={class:"header-row"},lt={key:0,class:"header-selector"},ot=["onClick"],nt={class:"header-title"},it={key:0,class:"sort-icon"},ct={class:"table-body"},ut={class:"customer-cell"},rt={class:"customer-name"},dt={class:"customer-phone"},vt={class:"products-cell"},ht={class:"product-count"},pt={class:"amount-cell"},ft={key:2,class:"empty-state"},mt={key:0,class:"table-pagination"},wt={class:"pagination-info"},_t={class:"pagination-controls"},gt=["disabled"],bt=["disabled"],kt={class:"reject-modal"},St=ye({__name:"index",setup(xt){Be();const o=Ce(),{selectedItems:d,selectAllChecked:V,selectAllIndeterminate:E,toggleSelection:X,selectAll:Y,clearSelection:$}=De(),Q=[{key:"quote_number",title:"报价单号",width:"150px",sortable:!0},{key:"customer",title:"客户信息",width:"200px"},{key:"products",title:"产品",width:"120px"},{key:"amount",title:"总金额",width:"120px",align:"right",sortable:!0},{key:"status",title:"状态",width:"100px",align:"center"},{key:"created_at",title:"创建时间",width:"150px",sortable:!0}],Z=Q.map(e=>({key:e.key,label:e.title,width:e.width,align:e.align,sortable:e.sortable,type:e.key==="amount"?"price":e.key==="created_at"?"date":e.key==="status"?"status":"text"}));function K(e){const a=[D.quotes.view];return e.status==="submitted"?a.push(D.quotes.approve,D.quotes.reject):e.status==="draft"&&a.push(D.quotes.edit),a}const ee=Qe.quotes,R=n(""),S=n("asc"),x=n(!1),u=n(0),h=n(""),P=Te(()=>Math.ceil(o.totalCount/A.value)),y=n(""),g=n(0),p=n(""),f=n(""),c=n(1),A=n(20),I=[{value:"",label:"全部状态"},{value:"draft",label:"草稿"},{value:"submitted",label:"待审批"},{value:"approved",label:"已批准"},{value:"rejected",label:"已拒绝"}],C=n(!1),j=n(null),T=n(""),O=n(!1);Se(()=>{r()});let z;const te=()=>{clearTimeout(z),z=setTimeout(()=>{c.value=1,r()},500)};async function r(){const e={page:c.value,pageSize:A.value};y.value&&(e.phone=y.value);const a=I[g.value].value;a&&(e.status=a),p.value&&(e.startDate=p.value),f.value&&(e.endDate=f.value),await o.fetchQuotes(e)}function ae(e,a){X(a.id)}function se(e){N(e)}function le(e,a){switch(e){case"view":N(a);break;case"approve":fe(a);break;case"reject":me(a);break;case"edit":pe(a);break;default:console.warn("Unknown action:",e)}}function M(e){const a=e.detail?e.detail.value:e;Y(o.quotes.map(b=>b.id),a)}function oe(e){R.value===e?S.value=S.value==="asc"?"desc":"asc":(R.value=e,S.value="asc"),c.value=1,r()}function ne(e){return R.value!==e?"↕":S.value==="asc"?"↑":"↓"}async function ie(e,a){switch(e){case"export":await ce();break;case"approve":await ue();break}}async function ce(){try{x.value=!0,u.value=0,h.value=`导出 ${d.value.length} 个报价单...`;const e=setInterval(()=>{u.value<90&&(u.value+=15)},200);await o.exportQuotes({quoteIds:d.value}),clearInterval(e),u.value=100,h.value="导出完成",uni.showToast({title:`成功导出 ${d.value.length} 个报价单`,icon:"success"}),$()}catch{uni.showToast({title:"批量导出失败",icon:"none"})}finally{setTimeout(()=>{x.value=!1,u.value=0,h.value=""},1e3)}}async function ue(){try{x.value=!0,u.value=0,h.value=`批准 ${d.value.length} 个报价单...`;const e=setInterval(()=>{u.value<90&&(u.value+=10)},300);await o.batchApproveQuotes(d.value),clearInterval(e),u.value=100,h.value="批准完成",uni.showToast({title:`成功批准 ${d.value.length} 个报价单`,icon:"success"}),$(),r()}catch{uni.showToast({title:"批量批准失败",icon:"none"})}finally{setTimeout(()=>{x.value=!1,u.value=0,h.value=""},1e3)}}function re(e){g.value=e.detail.value,c.value=1,r()}function de(e){p.value=e.detail.value,c.value=1,r()}function ve(e){f.value=e.detail.value,c.value=1,r()}function he(){y.value="",g.value=0,p.value="",f.value="",c.value=1,r()}function F(e){c.value=e,r()}function N(e){uni.navigateTo({url:`/pages/admin/quotes/detail?id=${e.id}`})}function pe(e){uni.navigateTo({url:`/pages/admin/quotes/edit?id=${e.id}`})}async function fe(e){uni.showModal({title:"确认批准",content:`确定要批准报价单 ${e.quote_number} 吗？`,success:async a=>{if(a.confirm)try{await o.approveQuote(e.id),uni.showToast({title:"批准成功",icon:"success"}),r()}catch{uni.showToast({title:"批准失败",icon:"none"})}}})}function me(e){j.value=e,T.value="",C.value=!0}async function we(){if(j.value)try{await o.rejectQuote(j.value.id,T.value),uni.showToast({title:"拒绝成功",icon:"success"}),C.value=!1,r()}catch{uni.showToast({title:"拒绝失败",icon:"none"})}}function _e(){C.value=!1,j.value=null,T.value=""}async function ge(){O.value=!0;try{await o.exportQuotes({status:I[g.value].value,startDate:p.value,endDate:f.value}),uni.showToast({title:"导出成功",icon:"success"})}catch{uni.showToast({title:"导出失败",icon:"none"})}finally{O.value=!1}}function be(e){return e.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}return(e,a)=>{const b=q("picker"),ke=q("checkbox"),xe=q("modal");return v(),w("view",qe,[t("view",Ve,[t("view",Ee,[a[7]||(a[7]=t("text",{class:"page-title"},"报价单管理",-1)),t("view",Pe,[t("text",ze,[t("text",Me,i(l(o).totalCount),1),a[5]||(a[5]=t("text",{class:"stat-label"},"总报价单",-1))]),t("text",Fe,[t("text",Ne,i(l(o).statistics.pending),1),a[6]||(a[6]=t("text",{class:"stat-label"},"待审批",-1))])])]),t("view",Ue,[t("button",{class:"export-btn",onClick:ge,loading:O.value},a[8]||(a[8]=[t("text",{class:"btn-icon"},"📊",-1),Ae(" 导出报表 ",-1)]),8,Le)])]),t("view",Ge,[t("view",He,[t("view",Je,[L(t("input",{"onUpdate:modelValue":a[0]||(a[0]=s=>y.value=s),class:"search-input",placeholder:"搜索手机号码",onInput:te},null,544),[[G,y.value]])]),t("view",We,[k(b,{mode:"selector",range:I,"range-key":"label",value:g.value,onChange:re},{default:_(()=>[t("view",Xe,[t("text",null,i(I[g.value].label),1),a[9]||(a[9]=t("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),t("view",Ye,[k(b,{mode:"date",value:p.value,onChange:de},{default:_(()=>[t("view",Ze,[t("text",null,i(p.value||"开始日期"),1),a[10]||(a[10]=t("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),t("view",Ke,[k(b,{mode:"date",value:f.value,onChange:ve},{default:_(()=>[t("view",et,[t("text",null,i(f.value||"结束日期"),1),a[11]||(a[11]=t("text",{class:"picker-arrow"},"▼",-1))])]),_:1},8,["value"])]),t("button",{class:"filter-reset",onClick:he},"重置")])]),t("view",tt,[t("view",at,[t("view",st,[l(d).length>0?(v(),w("view",lt,[k(ke,{checked:l(V),indeterminate:l(E),onChange:M},null,8,["checked","indeterminate"])])):B("",!0),(v(),w(H,null,J(Q,s=>t("view",{key:s.key,class:je(["header-cell",[`align-${s.align||"left"}`,{sortable:s.sortable}]]),style:Ie({width:s.width,flex:s.flex}),onClick:m=>s.sortable&&oe(s.key)},[t("text",nt,i(s.title),1),s.sortable?(v(),w("text",it,i(ne(s.key)),1)):B("",!0)],14,ot)),64))])]),t("view",ct,[l(o).loading?(v(),W($e,{key:0,rows:A.value,columns:Q.length,"has-selection":!0,"show-header":!1},null,8,["rows","columns"])):(v(!0),w(H,{key:1},J(l(o).quotes,s=>(v(),W(Oe,{key:s.id,item:s,columns:l(Z),selectable:!0,selected:l(d).includes(s.id),actions:K(s),"touch-optimized":!0,onSelect:ae,onClick:se,onAction:le},{"cell-customer":_(({item:m})=>[t("view",ut,[t("text",rt,i(m.customer_name),1),t("text",dt,i(m.customer_phone),1)])]),"cell-products":_(({item:m})=>{var U;return[t("view",vt,[t("text",ht,i(((U=m.items)==null?void 0:U.length)||0)+" 个产品",1)])]}),"cell-amount":_(({item:m})=>[t("text",pt,"¥"+i(be(m.total_amount)),1)]),_:2},1032,["item","columns","selected","actions"]))),128)),!l(o).loading&&l(o).quotes.length===0?(v(),w("view",ft,a[12]||(a[12]=[t("text",{class:"empty-text"},"暂无报价单数据",-1)]))):B("",!0)]),l(o).totalCount>A.value?(v(),w("view",mt,[t("view",wt," 共 "+i(l(o).totalCount)+" 条，第 "+i(c.value)+"/"+i(P.value)+" 页 ",1),t("view",_t,[t("button",{class:"pagination-btn",disabled:c.value<=1,onClick:a[1]||(a[1]=s=>F(c.value-1))}," 上一页 ",8,gt),t("button",{class:"pagination-btn",disabled:c.value>=P.value,onClick:a[2]||(a[2]=s=>F(c.value+1))}," 下一页 ",8,bt)])])):B("",!0)]),k(Re,{"selected-count":l(d).length,operations:l(ee),"show-progress":x.value,"current-progress":u.value,"progress-text":h.value,"select-all-checked":l(V),"select-all-indeterminate":l(E),onOperation:ie,onClearSelection:l($),onSelectAll:M},null,8,["selected-count","operations","show-progress","current-progress","progress-text","select-all-checked","select-all-indeterminate","onClearSelection"]),k(xe,{visible:C.value,"onUpdate:visible":a[4]||(a[4]=s=>C.value=s),title:"拒绝报价单",onConfirm:we,onCancel:_e},{default:_(()=>[t("view",kt,[a[13]||(a[13]=t("text",{class:"modal-label"},"拒绝原因（可选）：",-1)),L(t("textarea",{"onUpdate:modelValue":a[3]||(a[3]=s=>T.value=s),class:"reject-textarea",placeholder:"请输入拒绝原因...",maxlength:"200"},null,512),[[G,T.value]])])]),_:1},8,["visible"])])}}});export{St as default};
