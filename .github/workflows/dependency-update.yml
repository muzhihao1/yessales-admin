name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for dependency updates
        id: updates
        run: |
          npm outdated --json > outdated.json || true
          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available:"
            cat outdated.json | jq -r 'to_entries[] | "\(.key): \(.value.current) -> \(.value.wanted)"'
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No updates available"
          fi

      - name: Update patch and minor versions
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          # Update patch versions (safe updates)
          npm update
          
          # Check if package-lock.json was modified
          if git diff --name-only | grep -q package-lock.json; then
            echo "Dependencies updated"
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "No actual updates applied"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests after update
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          npm ci
          npm run lint
          npm run type-check
          npm run test
          npm run build

      - name: Check for security vulnerabilities
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          npm audit --audit-level moderate

      - name: Create Pull Request
        if: steps.updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ğŸ”„ Automated dependency updates'
          body: |
            ## ä¾èµ–æ›´æ–°æ‘˜è¦
            
            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ PRï¼Œç”¨äºæ›´æ–°é¡¹ç›®ä¾èµ–ã€‚
            
            ### æ›´æ–°å†…å®¹
            - âœ… è¡¥ä¸ç‰ˆæœ¬å’Œæ¬¡è¦ç‰ˆæœ¬æ›´æ–°
            - âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
            - âœ… å®‰å…¨å®¡è®¡é€šè¿‡
            - âœ… æ„å»ºæˆåŠŸ
            
            ### æ£€æŸ¥æ¸…å•
            - [x] è‡ªåŠ¨æµ‹è¯•é€šè¿‡
            - [x] å®‰å…¨æ‰«æé€šè¿‡
            - [ ] äººå·¥ä»£ç å®¡æŸ¥
            - [ ] åŠŸèƒ½æµ‹è¯•éªŒè¯
            
            ### æ›´æ–°è¯¦æƒ…
            è¯·æŸ¥çœ‹ `package-lock.json` çš„å˜æ›´è¯¦æƒ…ã€‚
            
            ---
            ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
          branch: dependency-updates
          delete-branch: true

  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for security vulnerabilities
        id: audit
        run: |
          npm audit --json > audit.json || true
          if [ -s audit.json ] && cat audit.json | jq -e '.vulnerabilities | length > 0' > /dev/null; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Security vulnerabilities found:"
            npm audit
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No security vulnerabilities found"
          fi

      - name: Fix security vulnerabilities
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        run: |
          npm audit fix
          
          # Check if package-lock.json was modified
          if git diff --name-only | grep -q package-lock.json; then
            echo "Security fixes applied"
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "No fixes applied"
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests after security fixes
        if: steps.audit.outputs.has_vulnerabilities == 'true' && steps.audit.outputs.fixed == 'true'
        run: |
          npm ci
          npm run lint
          npm run type-check
          npm run test
          npm run build

      - name: Create Security PR
        if: steps.audit.outputs.has_vulnerabilities == 'true' && steps.audit.outputs.fixed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'security: fix vulnerabilities'
          title: 'ğŸ”’ Security vulnerability fixes'
          body: |
            ## å®‰å…¨æ¼æ´ä¿®å¤
            
            è¿™æ˜¯ä¸€ä¸ªç´§æ€¥çš„å®‰å…¨æ›´æ–° PRã€‚
            
            ### ä¿®å¤å†…å®¹
            - ğŸ”’ ä¿®å¤äº†å·²çŸ¥çš„å®‰å…¨æ¼æ´
            - âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
            - âœ… æ„å»ºæˆåŠŸ
            
            ### ç´§æ€¥ç¨‹åº¦
            âš ï¸ **é«˜ä¼˜å…ˆçº§** - è¯·å°½å¿«å®¡æŸ¥å’Œåˆå¹¶
            
            ### æ£€æŸ¥æ¸…å•
            - [x] è‡ªåŠ¨æµ‹è¯•é€šè¿‡
            - [x] å®‰å…¨æ‰«æé€šè¿‡
            - [ ] ç´§æ€¥ä»£ç å®¡æŸ¥
            - [ ] ç«‹å³éƒ¨ç½²éªŒè¯
            
            ### æ¼æ´è¯¦æƒ…
            ```
            $(npm audit)
            ```
            
            ---
            ğŸš¨ æ­¤ PR åŒ…å«å®‰å…¨ä¿®å¤ï¼Œå»ºè®®ç«‹å³å¤„ç†
          branch: security-fixes
          delete-branch: true
          labels: |
            security
            priority-high

      - name: Notify security team
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: 'warning'
          channel: '#security'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          custom_payload: |
            {
              attachments: [{
                color: 'warning',
                title: 'ğŸ”’ Security Vulnerabilities Detected',
                text: 'Security vulnerabilities found in YesSales dependencies',
                fields: [{
                  title: 'Status',
                  value: '${{ steps.audit.outputs.fixed == "true" && "Fixes Applied" || "Manual Review Required" }}',
                  short: true
                }, {
                  title: 'Action Required',
                  value: 'Review and merge security PR',
                  short: true
                }]
              }]
            }